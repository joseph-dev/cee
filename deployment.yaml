# Namespaces
---
 apiVersion: v1
 kind: Namespace
 metadata:
   name: cee



# Deployments
---
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: redis
   namespace: cee
 spec:
   replicas: 1
   selector:
     matchLabels:
       app: redis
   template:
     metadata:
       labels:
         app: redis
     spec:
       containers:
         - name: redis
           image: redis
           ports:
             - containerPort: 6379

---
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: redis-commander
   namespace: cee
 spec:
   replicas: 1
   selector:
     matchLabels:
       app: redis-commander
   template:
     metadata:
       labels:
         app: redis-commander
     spec:
       containers:
         - name: redis-commander
           image: rediscommander/redis-commander:latest
           env:
             - name: REDIS_HOSTS
               value: redis
           ports:
             - containerPort: 8081

---
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: master
   namespace: cee
 spec:
   replicas: 1
   selector:
     matchLabels:
       app: master
   template:
     metadata:
       labels:
         app: master
     spec:
       containers:
         - name: master
           image: yosypmykhailiv/cee-master
           env:
             - name: KUBERNETES_NAMESPACE
               value: "cee"
             - name: RUNNERS
               value: "php7.1, php7.2, java8, java12"
             - name: RUNNER_IMAGE
               value: "yosypmykhailiv/cee-runner"
           ports:
             - containerPort: 3000



# Services
---
 apiVersion: v1
 kind: Service
 metadata:
   name: redis
   namespace: cee
 spec:
   selector:
     app: redis
   ports:
     - protocol: TCP
       port: 6379
       targetPort: 6379

---
 apiVersion: v1
 kind: Service
 metadata:
   name: redis-commander
   namespace: cee
 spec:
   selector:
     app: redis-commander
   ports:
     - protocol: TCP
       port: 8081
       targetPort: 8081

---
 apiVersion: v1
 kind: Service
 metadata:
   name: master
   namespace: cee
 spec:
   selector:
     app: master
   type: LoadBalancer
   ports:
     - protocol: TCP
       port: 80
       targetPort: 3000



# Role management
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: job-handler
  namespace: cee
rules:
  - apiGroups: [ "" ]
    resources: [ "nodes", "pods"]
    verbs: [ "get", "list", "watch"]
  - apiGroups: [ "batch" ]
    resources: [ "jobs" ]
    verbs: [ "create", "get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: default-job-handler
  namespace: cee
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: job-handler
subjects:
  - kind: ServiceAccount
    name: default
    namespace: cee
